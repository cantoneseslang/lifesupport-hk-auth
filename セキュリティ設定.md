# セキュリティ設定ガイド

## セキュリティ概要

本システムはSupabase認証とGoogle Apps Scriptを組み合わせたセキュアなアンケートシステムです。会員登録・認証・ログイン機能により、認証済みユーザーのみがアンケートにアクセスできます。

## Supabase認証設定

### 1. Supabaseプロジェクト設定

```javascript
// Supabase設定
const SUPABASE_CONFIG = {
  URL: 'https://ihviwvlptzalbrjktddf.supabase.co',
  API_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlodml3dmxwdHphbGJyamt0ZGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDI1ODksImV4cCI6MjA3Njg3ODU4OX0.UjNdR4bOdaDmznucIZ5K-ZNMEDGPbVBAT5D40Mf-E60',
  MCP_URL: 'https://mcp.supabase.com/mcp?project_ref=ihviwvlptzalbrjktddf'
};
```

### 2. 認証フロー

1. **会員登録**
   - メールアドレス・パスワード入力
   - 会員情報登録（名前、会社名、電話番号等）
   - 認証メール送信

2. **メール認証**
   - 認証メール内のリンクをクリック
   - アカウント有効化
   - ログイン可能状態に変更

3. **ログイン**
   - メールアドレス・パスワード入力
   - 認証トークン取得
   - セッション開始

4. **アンケートアクセス**
   - 認証トークン検証
   - セキュアアンケートフォーム表示
   - 回答データの保護

## セキュリティ機能

### 1. 認証・認可

#### JWT認証
- アクセストークンによる認証
- リフレッシュトークンによる自動更新
- トークン有効期限管理

#### セッション管理
- セキュアなセッション情報保存
- 自動ログアウト機能
- セッション有効期限管理

### 2. データ保護

#### 個人情報保護
- 暗号化されたデータ保存
- アクセス権限の制限
- データの匿名化処理

#### データ検証
- 入力データの検証
- SQLインジェクション対策
- XSS攻撃対策

### 3. セキュリティレベル

#### レベル判定基準
- **High**: 全項目同意 + 高推奨度 + 高満足度
- **Standard**: 通常の回答
- **Low**: 基本情報のみ

#### セキュリティ対策
- データアクセス制限
- ログ記録・監視
- 異常検知・通知

## データベースセキュリティ

### 1. Supabase設定

#### Row Level Security (RLS)
```sql
-- 会員テーブルのRLS設定
CREATE POLICY "Members can view own data" ON members
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Members can update own data" ON members
  FOR UPDATE USING (auth.uid() = id);
```

#### データベース権限
- 最小権限の原則
- 読み取り専用ユーザー
- 管理者権限の分離

### 2. MCP連携セキュリティ

#### API認証
- APIキーの適切な管理
- リクエスト制限
- ログ記録・監視

#### データ同期
- 暗号化された通信
- データ整合性チェック
- エラーハンドリング

## セキュリティ監視

### 1. ログ監視

#### 認証ログ
- ログイン試行記録
- 失敗回数カウント
- 異常アクセス検知

#### 操作ログ
- データアクセス記録
- 変更履歴追跡
- セキュリティイベント記録

### 2. アラート設定

#### 異常検知
- 複数回ログイン失敗
- 異常なアクセスパターン
- データ漏洩の可能性

#### 通知設定
- 管理者への即座通知
- セキュリティチームへの連絡
- 自動対応処理

## セキュリティテスト

### 1. 認証テスト

#### ログイン機能
- 正常ログインテスト
- 不正ログインテスト
- セッション管理テスト

#### 権限テスト
- アクセス権限テスト
- データ操作権限テスト
- 管理者権限テスト

### 2. データ保護テスト

#### 暗号化テスト
- データ暗号化確認
- 通信暗号化確認
- キー管理テスト

#### 漏洩対策テスト
- データ漏洩シミュレーション
- アクセス制限テスト
- 監査ログテスト

## セキュリティポリシー

### 1. アクセス制御

#### ユーザー権限
- 一般会員: アンケート回答のみ
- 管理者: データ閲覧・管理
- システム管理者: 全機能アクセス

#### データアクセス
- 個人情報の制限
- 統計データの匿名化
- 機密情報の保護

### 2. データ取り扱い

#### 個人情報保護
- 最小限の情報収集
- 目的外利用の禁止
- 適切な廃棄処理

#### データ保存
- 暗号化保存
- バックアップ管理
- アクセス制限

## 緊急時対応

### 1. セキュリティインシデント

#### 対応手順
1. インシデント検知
2. 影響範囲の特定
3. 緊急対応の実施
4. 復旧作業の実行
5. 事後分析・改善

#### 連絡先
- セキュリティチーム
- システム管理者
- 外部セキュリティ専門家

### 2. データ漏洩対応

#### 即座対応
- システム停止
- アクセス遮断
- 影響範囲の特定

#### 復旧作業
- データ復旧
- システム再構築
- セキュリティ強化

## セキュリティ教育

### 1. ユーザー教育

#### セキュリティ意識
- パスワード管理
- フィッシング対策
- セキュアな利用方法

#### 利用規約
- セキュリティポリシーの理解
- データ取り扱いルール
- 違反時の対応

### 2. 管理者教育

#### セキュリティ管理
- 監視方法の習得
- インシデント対応
- セキュリティ更新

#### 技術研修
- 最新セキュリティ技術
- 脅威情報の収集
- 対策の実装

## セキュリティ更新

### 1. 定期更新

#### システム更新
- セキュリティパッチ適用
- 脆弱性対策
- 機能強化

#### ポリシー更新
- セキュリティポリシー見直し
- 利用規約更新
- 教育内容の更新

### 2. 緊急更新

#### 脆弱性対応
- 緊急パッチ適用
- 一時的対策
- 根本的解決

#### 脅威対応
- 新たな脅威への対策
- セキュリティ強化
- 監視体制の見直し
